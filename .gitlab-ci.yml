image: debian:bullseye-slim

stages:
  - build
  - deploy

variables:
  CV_SOURCE: cv.typ
  OUTPUT_FILE: cv.pdf
  TYPST_VERSION: "v0.13.0"  # Adjust this to your preferred Typst version

compile_cv:
  stage: build
  script:
    # Install minimal dependencies
    - apt-get update && apt-get install -y curl xz-utils fontconfig
    
    # Install Typst
    - curl -L https://github.com/typst/typst/releases/download/${TYPST_VERSION}/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJf - -C /tmp
    - mv /tmp/typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    - chmod +x /usr/local/bin/typst
    
    # Setup fonts from repository
    - mkdir -p ~/.fonts/
    - cp *.otf ~/.fonts/ || true
    - cp *.ttf ~/.fonts/ || true
    - fc-cache -f -v
    
    # List available fonts for debugging
    - echo "Available fonts:"
    - fc-list | grep -i "awesome\\|roboto"
    
    # Download complete Roboto Slab font family
    - apt-get install -y wget
    - mkdir -p ~/.fonts/roboto-slab
    - for weight in Regular Bold Light Thin Medium SemiBold ExtraLight Black; do
        wget -q "https://fonts.gstatic.com/s/robotoslab/v25/BngbUXZYTXPIvIBgJJSb6s3BzlRRfKOFbvj0_Yk${weight}aG5iddG-1A.ttf" -O ~/.fonts/roboto-slab/RobotoSlab-${weight}.ttf || echo "Failed to download ${weight}";
      done
    - fc-cache -f -v
    
    # Show Typst version
    - typst --version
    
    # Compile the CV
    - echo "Compiling CV with Typst..."
    - typst compile $CV_SOURCE $OUTPUT_FILE
    - echo "CV compilation complete"
  artifacts:
    paths:
      - $OUTPUT_FILE
    expire_in: 1 week

# Deploy to GitLab Pages if desired
pages:
  stage: deploy
  script:
    - mkdir -p public
    - cp $OUTPUT_FILE public/
    - echo "PDF available at ${CI_PAGES_URL}/${OUTPUT_FILE}"
  artifacts:
    paths:
      - public
  only:
    - main  # Only run on the main branch